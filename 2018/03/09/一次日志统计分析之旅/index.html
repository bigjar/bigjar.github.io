<!DOCTYPE html><html lang="cn"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="一次日志统计分析之旅"><meta name="keywords" content="Spark,Flume,Kafka"><meta name="author" content="MrHup"><meta name="copyright" content="MrHup"><title>一次日志统计分析之旅 | MrHup的时光机</title><link rel="shortcut icon" href="/melody-favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.7.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.7.0"><meta name="format-detection" content="telephone=no"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  }
} </script><meta name="generator" content="Hexo 4.2.0"></head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar" data-display="true"><div class="toggle-sidebar-info text-center"><span data-toggle="Toggle article">Toggle site</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">Catalog</div><div class="sidebar-toc__progress"><span class="progress-notice">You've read</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-数据采集"><span class="toc-number">1.</span> <span class="toc-text">1. 数据采集</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-source"><span class="toc-number">1.1.</span> <span class="toc-text">1.1 source</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-channel"><span class="toc-number">1.2.</span> <span class="toc-text">1.2 channel</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3-sink"><span class="toc-number">1.3.</span> <span class="toc-text">1.3 sink</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-消息队列"><span class="toc-number">2.</span> <span class="toc-text">2. 消息队列</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-数据存储"><span class="toc-number">3.</span> <span class="toc-text">3. 数据存储</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-HBase"><span class="toc-number">3.1.</span> <span class="toc-text">3.1 HBase</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-Hive"><span class="toc-number">3.2.</span> <span class="toc-text">3.2 Hive</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-Elasticsearch"><span class="toc-number">3.3.</span> <span class="toc-text">3.3 Elasticsearch</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-离线分析"><span class="toc-number">4.</span> <span class="toc-text">4. 离线分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Apache-Spark-core"><span class="toc-number">4.1.</span> <span class="toc-text">Apache Spark core</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Spark-SQL"><span class="toc-number">4.2.</span> <span class="toc-text">Spark SQL</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Spark-Streaming"><span class="toc-number">4.3.</span> <span class="toc-text">Spark Streaming</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#MLib"><span class="toc-number">4.4.</span> <span class="toc-text">MLib</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#GraphX"><span class="toc-number">4.5.</span> <span class="toc-text">GraphX</span></a></li></ol></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="/img/avatar.png"></div><div class="author-info__name text-center">MrHup</div><div class="author-info__description text-center">stay hungry, stay foolish</div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">Articles</span><span class="pull-right">35</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">Tags</span><span class="pull-right">27</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">Categories</span><span class="pull-right">6</span></a></div></div></div><div id="content-outer"><div class="no-bg" id="top-container"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">MrHup的时光机</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus">   <a class="site-page" href="/">Home</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/tags">Tags</a><a class="site-page" href="/categories">Categories</a></span><span class="pull-right"></span></div><div id="post-info"><div id="post-title">一次日志统计分析之旅</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2018-03-09</time><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/%E5%A4%A7%E6%95%B0%E6%8D%AE/">大数据</a></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><p>随着移动互联网、云计算、物联网的崛起与发展，大数据的时代已经来临。当数据量不停增长时，如何实时查询和分析业务的状况变的业务状况变的越来越重要。<br>本文主要包含以下几个方面：</p>
<ol>
<li>数据采集</li>
<li>消息队列</li>
<li>数据存储</li>
<li>离线分析</li>
</ol>
<p>当数据产生时，通过flume客户端去采集数据，然后放入kafka消息队列中，接着通过flume服务端去消费这个数据，最终把数据放入es、hbase、mongodb等数据库中。<br><img src="%E6%9E%B6%E6%9E%84.png" alt="架构"></p>
<h2 id="1-数据采集"><a href="#1-数据采集" class="headerlink" title="1. 数据采集"></a>1. 数据采集</h2><p>Flume是一个分布式的、高可用的日志收集系统。Flume-NG采用三层架构设计：收集（source）、暂存（channel）、处理（sink）。如图所示：<br><img src="flume.png" alt="event在agent中的传输过程"></p>
<h3 id="1-1-source"><a href="#1-1-source" class="headerlink" title="1.1 source"></a>1.1 source</h3><p>source用来对接各种数据源，将收集到的数据存入channel中。<br>常用的source类型有Avro source、Exec source、Kafka source等。<br>Avro source通过监听Avro端口接收外部客服端流事件，在flume多层架构中常被用来接收上层agent sink发送的event。<br>Kafka source用来对接分布式消息队列kafka，作为kafka的消费者持续从kafka中拉取数据。<br>Exec source收集标准输出数据或者通过tail -f file的方式监听指定文件。但是不支持断点续传（不记录读取文件的位置）。</p>
<h3 id="1-2-channel"><a href="#1-2-channel" class="headerlink" title="1.2 channel"></a>1.2 channel</h3><p>channel为event中的缓冲区，存储source收集并且没有被sink读取的event，平衡source收集和sink读取数据的速度，相当于flume内部的消息队列。<br>常用的channel类型有memory channel、file channel、kafka channel。<br>memory channel读写速度快，但是存储小，flume进程挂掉时，数据会丢失。<br>file channel将event写入磁盘文件，存储大，无数据丢失风险。<br>kafka channel将kafka作为channel存储。kafka channel相对于memory channel和file channel存储容量大，容错能力强。在日志收集层，可以只配置source组件和kafka channel组件，不需要再配置sink组件，可以减少日志收集层启动的进程数并且有效降低服务器内存、磁盘等资源使用率。再日志汇聚层，可以只配置kafka channel和sink，不需要再配置source，减少日志汇聚层的进程数，这样能降低服务器的资源利用率和减少event再网络之间的传输，有效提高日志采集系统的性能。</p>
<h3 id="1-3-sink"><a href="#1-3-sink" class="headerlink" title="1.3 sink"></a>1.3 sink</h3><p>avro sink常用来对接下一层的avro source，通过发送rpc请求将event发送到下一层的avro source。<br>hdfs sink用来将event写入hdfs文件存储。<br>kafka sink将evnet写入到kafka主题中。<br>本文采用exec source作为source，channel采用file channel，sink采用kafka sink。这样可以采集不同的数据源，然后分发到不同的kafka topic中。</p>
<h2 id="2-消息队列"><a href="#2-消息队列" class="headerlink" title="2. 消息队列"></a>2. 消息队列</h2><p>kafka是一个开源的分布式消息队列，具有高吞吐、可扩展、高可用的特性。<br><img src="kafka.png" alt="kafka架构图"><br>一个kafka集群可以有多个kafka实例，由zookeeper协调管理（保存kafka元数据、动态扩展、负载均衡）。一个kafka实例就是一个broker。broker中有包含topic，topic相当于一个数据库表，一个topic可以分为多个partition和多个replication。producer将同一类型的消息写入同一个topic中，consumer从同一个topic消费同一类型的数据。<br>kafka之所以能够实现高吞吐、可扩展、高可用，是因为它基于磁盘顺序读写（比内存读写性能还高），pagecache、sendfile技术（零拷贝）、多分区（一个分区代表一个线程）。</p>
<h2 id="3-数据存储"><a href="#3-数据存储" class="headerlink" title="3. 数据存储"></a>3. 数据存储</h2><p>flume服务端通过消费kafka中的topic，把日志写入到各个数据库中。</p>
<h3 id="3-1-HBase"><a href="#3-1-HBase" class="headerlink" title="3.1 HBase"></a>3.1 HBase</h3><p>HBase是一个分布式的、持久的、强一致性的存储系统，具有尽似最优的写性能和出色的读性能。HBase和传统型关系型数据库相比，就是使用了LSM树做为底层数据结构。LSM树以磁盘传输速率工作并能较好地扩展以处理大量的数据，它们使用日志文件和内存存储来将随机写转换成顺序写，因此也能保证稳定的数据插入速率。又由于读写独立，因此两种操作之间没有冲突。<br>Hbase中有3个主要组件：客户端库、一台主服务器和多台region服务器。region服务器可以根据负载的变化动态添加和移除。主服务器主要负责利用zookeeper为region服务器分配region。<br><img src="hbase.png" alt="hbase架构图"><br>主服务器不负责数据服务，只提供region管理和元数据的管理。region服务器提供读写服务。HBase主要处理两种文件，预写日志和实际的数据文件，两者由HRegionServer管理。<br>HBase中的行键设计非常重要，它是用来定位具体一行的数据的，通过行键的查询是最快的。但是如果按照特定序列来命名，容易造成region热点，在某一时间段数据全往一个region中写。一般通过加入salt或者哈希随机化来设计行键。但反过来，随机写带来的一个坏处是会造成顺序读的性能下降。</p>
<h3 id="3-2-Hive"><a href="#3-2-Hive" class="headerlink" title="3.2 Hive"></a>3.2 Hive</h3><p>Hive是一个建立在Hadoop架构上的数据仓库。它能够提供数据的精炼，查询和分析。它可以将结构化的数据文件映射为一张数据库表，并提供sql查询功能。<br>Hive可以映射hdfs或者hbase来建立外表，然后通过hql语句来查询相应的数据。同时可以按天建立分区表，减少查询的数据量。值得注意的是，外表以及通过外表建立的分区表，在删表时并不会删除数据。</p>
<h3 id="3-3-Elasticsearch"><a href="#3-3-Elasticsearch" class="headerlink" title="3.3 Elasticsearch"></a>3.3 Elasticsearch</h3><p>Elasticsearch是一款开源的、分布式的、restful风格的搜索引擎。它内部使用Lucene做索引与搜索。它有如下特点：</p>
<ul>
<li>一个分布式的实时文档存储，每个字段可以被索引与搜索</li>
<li>一个分布式实时分析搜索引擎</li>
<li>能胜任上百个服务器节点的扩展，并支持PB级别的结构化或者非结构化的数据</li>
</ul>
<h2 id="4-离线分析"><a href="#4-离线分析" class="headerlink" title="4. 离线分析"></a>4. 离线分析</h2><p>Spark是一款开源的分布式大数据处理通用引擎，具有高吞吐、低延时、可扩展、高容错等特点。它包括离线计算、交互式查询、数据挖掘算法、流式计算及图计算。<br>Spark包含以下几个组件：<br><img src="spark%E7%BB%84%E4%BB%B6.png" alt="Spark组件"></p>
<h3 id="Apache-Spark-core"><a href="#Apache-Spark-core" class="headerlink" title="Apache Spark core"></a>Apache Spark core</h3><p>Apache Spark core是spark平台的核心组件，其他组件都依赖于它。它主要负责：</p>
<ul>
<li>内存管理和故障恢复</li>
<li>在集群上安排、分布和监控作业</li>
<li>和存储系统进行交互</li>
</ul>
<h3 id="Spark-SQL"><a href="#Spark-SQL" class="headerlink" title="Spark SQL"></a>Spark SQL</h3><p>Spark SQL是Spark Core之上的一个组件，它引入了一个称为SchemaRDD的新数据抽象，它为结构化和半结构化数据提供支持（Hive等）。<br><img src="spark-sql.png" alt="Spark SQL"><br>如果配置支持hive，当Spark SQL进行编程或者查询时，可以使用HiveSQL作为查询语言。</p>
<h3 id="Spark-Streaming"><a href="#Spark-Streaming" class="headerlink" title="Spark Streaming"></a>Spark Streaming</h3><p>Spark Streaming利用Spark Core的快速调度功能来执行流式分析。它以小批量获取数据，并对这些小批量的数据执行RDD（弹性分布式数据集）转换。</p>
<h3 id="MLib"><a href="#MLib" class="headerlink" title="MLib"></a>MLib</h3><p>MLlib是Spark之上的分布式机器学习框架，因为基于分布式内存的Spark架构。根据基准，它是由MLlib开发人员针对交替最小二乘法（ALS）实现完成的。 Spark MLlib是基于Hadoop磁盘的Apache Mahout版本的9倍（在Mahout获得了Spark接口之前）。</p>
<h3 id="GraphX"><a href="#GraphX" class="headerlink" title="GraphX"></a>GraphX</h3><p>GraphX是Spark上的一个分布式图形处理框架。它提供了一个用于表达图形计算的API，可以通过使用Pregel抽象API为用户定义的图形建模。它还为此抽象提供了一个优化的运行时。</p>
<p>相对于Hadoop，spark采用了DAG执行引擎，支持循环数据流和内存计算，在内存中的速度是hadoop的100倍，磁盘上的速度是hadoop的10倍。<br>Spark实现了DAG的计算模型，DAG计算模型是指将一个任务按照计算规则分解为若干子任务，这些子任务之间根据逻辑关系构建有向无环图。<br><img src="spark.png" alt="Spark架构图"><br>Spark计算操作都是基于RDD进行的。RDD具体只读、多分区、分布式的特性。外部的文件系统的文件如hbase，hdfs都可以转换为RDD。同时一个或者多个RDD可以转换为新的RDD。<br>RDD提供Transformation和Action两种计算类型。Transformation的操作只有当Action的时候才会真正的执行操作。同时RDD可以缓存到内存或者磁盘中，这样可以减少网络传输次数，提高spark的计算性能。</p>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined">MrHup</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="http://yoursite.com/2018/03/09/%E4%B8%80%E6%AC%A1%E6%97%A5%E5%BF%97%E7%BB%9F%E8%AE%A1%E5%88%86%E6%9E%90%E4%B9%8B%E6%97%85/">http://yoursite.com/2018/03/09/%E4%B8%80%E6%AC%A1%E6%97%A5%E5%BF%97%E7%BB%9F%E8%AE%A1%E5%88%86%E6%9E%90%E4%B9%8B%E6%97%85/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="noopener">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Spark/">Spark</a><a class="post-meta__tags" href="/tags/Flume/">Flume</a><a class="post-meta__tags" href="/tags/Kafka/">Kafka</a></div><nav id="pagination"><div class="prev-post pull-left"><a href="/2018/04/08/Swift%E5%92%8CObjective-C%E7%9A%84%E5%8D%81%E4%B8%AA%E4%B8%8D%E5%90%8C%E7%82%B9/"><i class="fa fa-chevron-left">  </i><span>Swift和Objective-C的十个不同点</span></a></div><div class="next-post pull-right"><a href="/2018/01/30/Category%E4%B8%8EExtension/"><span>Category与Extension</span><i class="fa fa-chevron-right"></i></a></div></nav></div></div><footer><div class="layout" id="footer"><div class="copyright">&copy;2013 - 2020 By MrHup</div><div class="framework-info"><span>Driven - </span><a href="http://hexo.io" target="_blank" rel="noopener"><span>Hexo</span></a><span class="footer-separator">|</span><span>Theme - </span><a href="https://github.com/Molunerfinn/hexo-theme-melody" target="_blank" rel="noopener"><span>Melody</span></a></div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.7.0"></script><script src="/js/fancybox.js?version=1.7.0"></script><script src="/js/sidebar.js?version=1.7.0"></script><script src="/js/copy.js?version=1.7.0"></script><script src="/js/fireworks.js?version=1.7.0"></script><script src="/js/transition.js?version=1.7.0"></script><script src="/js/scroll.js?version=1.7.0"></script><script src="/js/head.js?version=1.7.0"></script><script>if(/Android|webOS|iPhone|iPod|iPad|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
  $('#top-container').addClass('is-mobile')
}</script></body></html>